{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block header_title %}lacunary - {{ index_title }}{% endblock %}
{% block header_link %}{{ url_for('mathnotes_index') }}{% endblock %}

{% block body_class %}block-index-page{% endblock %}

{% block description %}{{ page_description }}{% endblock %}

{% block content %}
<div class="block-index-container">
    <h2>{{ index_title }}</h2>
    <p class="index-description">
        {{ index_description }}
    </p>
    
    {% if blocks %}
        <div class="block-count">
            Found {{ blocks|length }} {{ item_type }}{{ 's' if blocks|length != 1 else '' }}
        </div>
        
        <div class="blocks-list">
            {% for item in blocks %}
                <div class="embedded-block" data-embed-label="{{ item.block.block.label }}">
                    {{ item.block.block.rendered_html|safe }}
                    <div class="embedded-source">from <a href="{{ item.block.full_url }}">{{ item.block.page_title }}</a></div>
                    
                    {% if item.direct_references or item.transitive_references %}
                        <div class="block-references">
                            <details>
                                <summary>Referenced by ({{ item.direct_references|length }} direct{% if item.transitive_references %}, {{ item.transitive_references.values()|map('length')|sum }} transitive{% endif %})</summary>
                                
                                {% if item.direct_references %}
                                    <div class="direct-references">
                                        <h4>Direct references:</h4>
                                        <ul>
                                            {% for ref in item.direct_references %}
                                                <li>
                                                    {% if ref.source_url %}
                                                        <a href="{{ ref.source_url }}">
                                                            {% if ref.source_title %}
                                                                {{ ref.source_title }}
                                                            {% else %}
                                                                {{ ref.source_file }}
                                                            {% endif %}
                                                        </a>
                                                    {% else %}
                                                        {{ ref.source_title or ref.source_file }}
                                                    {% endif %}
                                                    {% if ref.is_embed %}
                                                        <span class="ref-type">(embedded)</span>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                
                                {% if item.transitive_references %}
                                    <div class="transitive-references">
                                        {% for depth, refs in item.transitive_references.items() %}
                                            <h4>Transitive (depth {{ depth }}):</h4>
                                            <ul>
                                                {% for ref in refs %}
                                                    <li>
                                                        {% if ref.source_url %}
                                                            <a href="{{ ref.source_url }}">
                                                                {% if ref.source_title %}
                                                                    {{ ref.source_title }}
                                                                {% else %}
                                                                    {{ ref.source_label or ref.source_file }}
                                                                {% endif %}
                                                            </a>
                                                        {% else %}
                                                            {{ ref.source_title or ref.source_label or ref.source_file }}
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </details>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-items">{{ no_items_message }}</p>
    {% endif %}
</div>
{% endblock %}
