# Development static builder - builds everything at runtime in a loop
FROM python:3.12-slim

WORKDIR /app

# Install git for version info and node for vite builds
RUN apt-get update && \
    apt-get install -y git curl && \
    curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Copy Python requirements and install
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy package files and install node dependencies
COPY package*.json ./
COPY tsconfig.json ./
COPY vite.config.ts ./
COPY postcss.config.js ./
RUN npm ci

# Copy all application code
COPY mathnotes/ ./mathnotes/
COPY content/ ./content/
COPY templates/ ./templates/
COPY scripts/build_static.py ./scripts/
COPY demos-framework/ ./demos-framework/
COPY styles/ ./styles/
COPY demos/ ./demos/
COPY favicon.ico robots.txt ./
COPY .git/ ./.git/

# Set production environment for static build
ENV FLASK_ENV=production
ENV FLASK_DEBUG=0

# Create a wrapper script that rebuilds everything in a loop
RUN echo '#!/bin/sh\n\
mkdir -p /version\n\
git describe --always --tags > /version/version.txt || echo "unknown" > /version/version.txt\n\
# Rebuild loop - rebuild everything every 15 seconds\n\
while true; do\n\
    echo "[$(date)] Starting full rebuild..."\n\
    # Build Vite assets\n\
    echo "[$(date)] Building Vite assets..."\n\
    npm run build\n\
    # Build static site to a subdirectory within the volume\n\
    echo "[$(date)] Building static content..."\n\
    mkdir -p /app/static-build\n\
    python scripts/build_static.py -o /app/static-build/website --no-vite\n\
    echo "[$(date)] Full rebuild complete, sleeping for 15 seconds..."\n\
    ls -la /app/static-build/website/ | head -20\n\
    sleep 15\n\
done' > /app/build-and-run.sh && chmod +x /app/build-and-run.sh

CMD ["/app/build-and-run.sh"]