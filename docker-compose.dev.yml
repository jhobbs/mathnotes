services:
  static-builder:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - static-build:/app/static-build
      - ./content:/app/content:ro
      - ./mathnotes:/app/mathnotes:ro
      - ./templates:/app/templates:ro
      - ./demos:/app/demos:ro
      - ./demos-framework:/app/demos-framework:ro
      - ./styles:/app/styles:ro
      - ./scripts:/app/scripts:ro
    container_name: mathnotes-static-builder
    
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    ports:
      - "5000:5000"
    volumes:
      - static-build:/app/static-build:ro
      - ./server:/app/server
    environment:
      - STATIC_BUILD_DIR=/app/static-build/website
    container_name: web-dev
    restart: unless-stopped
    depends_on:
      - static-builder
  crawler:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    volumes:
      - ./crawler:/usr/src/app/crawler
      - /usr/src/app/node_modules
    environment:
      - NODE_ENV=development
    # Don't run automatically, use docker-compose run
    command: echo "Crawler ready. Use 'docker-compose -f docker-compose.dev.yml run --rm crawler npx tsx crawler.ts <url>' to run"
    profiles:
      - tools
volumes:
  static-build:
