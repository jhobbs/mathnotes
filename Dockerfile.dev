# Development static builder - builds everything at runtime in a loop
FROM python:3.12-slim

WORKDIR /app

# Install git for version info and node for vite builds
RUN apt-get update && \
    apt-get install -y git curl && \
    curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Copy Python requirements and install
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy package files and install node dependencies
COPY package*.json ./
COPY tsconfig.json ./
COPY esbuild.config.js ./
COPY postcss.config.js ./
RUN npm ci

# Copy all application code
COPY mathnotes/ ./mathnotes/
COPY content/ ./content/
COPY templates/ ./templates/
COPY scripts/build_static.py ./scripts/
COPY scripts/smart-rebuild.sh ./scripts/
COPY demos-framework/ ./demos-framework/
COPY styles/ ./styles/
COPY demos/ ./demos/
COPY favicon.ico robots.txt ./
COPY .git/ ./.git/

# Set production environment for static build
ENV FLASK_ENV=production
ENV FLASK_DEBUG=0

CMD ["/app/scripts/smart-rebuild.sh"]